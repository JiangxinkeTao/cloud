----------
#### 同步要点

 1. 逻辑部分去float，可以使用分数表示，记录一对分子分母（定点数?）
 3. 没有HostPlayer
 4. 一致的随机数种子
 5. 遍历的顺序：
	 1. Hashtable --> SortedDictionary
	 2. Raycast返回的结果：物品带唯一id，排序后使用第一个
	 3. Lua Table ：Pairs --> iPairs
 6. **数据层**避免受**逻辑层**反向影响：比如某些客户端资源加载未完成导致代码流程不一定的情况
 7. 虽然数据层不能裁剪，但是在逻辑层却是可以的
 8. 各client的update频率必须一致
 9. 数据层只能使用数据层的数据，不能使用其它的本地数据（不能引入其它任何的命名空间）：
	 1. 摄像机、子弹的位置
	 2. 人是否可见
 10.  注意未初始化的成员变量（出错时是很难意识到的），特别是如果使用了其它库的话（尽量不要用）
 11. Transform的更新顺序：比如Camera, Player, HUD的更新顺序如果有问题，会导致看起来HUD抖动

----------
#### 网络要点

影子跟随算法：数据层与逻辑层分离，数据层完全与服务器同步一致，逻辑层自己做插值平滑；逻辑帧并不等待客户端的command的，没有服务器数据的话就假定使用上一帧的数据（特别是移动相关的）

通常要求网速RTT在100ms以内，一般不超过8人。

1. 无buffer帧同步，数据层0延迟
2. 不使用P2P
3. 使用UDP
	1. 加快发送频率，多发，做冗余，做窗口排序
	2. UDP连不上的时候还要退回到TCP
	3. 《TCP/IP详解》
4. 网络延迟：是不是可以自己在编辑器里设置（比如400ms），为了调试方便
5. 网络流量 = 指令个数 x 同步频率
6. 断线重连（中途加入） = 快照 + 增量

##### 帧同步buffer机制

帧buffer 	| 延迟		| 卡顿
---			|--- 		|---
帧buffer小	| 延迟低	| 卡顿多
帧buffer大  | 延迟高	| 卡顿少

----------
#### 状态同步 VS. 帧同步

针对帧同步的一些缺点，需要注意设计时规避

|Topic 		| 状态同步	| 帧同步 |
| ---- | ---- | ---- |
|反外挂		| 服务器说了算				| 很容易修改client数据（王者荣耀：单局，弱成长线）|
|网络带宽、抖动	|适应能力强，300ms延迟无所谓 |  网络命令的延迟会引起挤压、卡顿|
|断线重连	| 状态同步即可，比较快	| 断线重回的时间**非常非常长**|
|网络流量 | 一场PVP，可能几十M	| 基本上是稳定的，观战、录像|
|客户端性能优化 | 视窗裁剪，看不见的地方不计算 | 不适合同场景几百上千人的大型游戏|
|开发效率 | 有时很难做到跟服务器状态一致	| 开发思路跟单机类似|
|强体格斗游戏 | 做精确同步数据量会非常大 | 动作本身的密度可以做到很高的频率|
|离线战斗 | 额外开发 | 原生支持|
|example	| Dota2, LOL, 守望先锋	| DOTA(Warcraft3)，风暴英雄(StarCraft2)，王者荣耀|

----------
#### C# VS. C++

Topic 	| C# 	| C++
---		|--- 	|---
debug	| 可以用断点 | 需要先编译成.a文件
speed	| slow	| fast，2.5倍差距，2~3帧的提升
anti-cheat	| 裸奔 | 安全
online-update | can | can't
GC		| 有	| 无


Topic 		| 序列化 	| 内存快照
---			|--- 		|---
speed		| slow   	| fast
version	    | possible	| impossible
存盘		| 是		| 否
coding	  	| 无限制	| struct，不能使用虚函数
版本维护	| 考虑兼容	| 只支持当前版本

----------
#### 反外挂

> 要不要跑两种验证机制：1v1时跑server验证，2v2时投票；要不要分成大验证与小验证

Cheat 		| Anti-Cheat
---			|---
修改属性	| 只改本地数据，别的client还是正确的；属性算个hash传给server验证（或投票）；加密
透视			| 开图挂，对于一些关键的点数据（如开图的bool变量）上传验证
自动操作	| 自动瞄准对FPS游戏影响大，发动玩家举报
皮肤美化 | ......

----------
#### 守望先锋（状态同步）

1. 服务器帧率20fps， 客户端60fps
2. favor the shooters：
	1. 只要你瞄准了，并开枪，基本上应该会击中目标，除非目标躲避了射击（比如：猎空使用了闪现）
	2. 因为客户端先行，所以客户端的位置和状态会比服务器更靠前，这个距离差反映了信息从服务器传到客户端所需要的时间
	3. 服务器有一定的缓冲数据，这样可以把下行到服务器的信息处理的更流畅，这个服务器的缓冲区很重要，因为我们不知道客户端的更新频率会不会受到阻碍（路由、硬件、网络抖动）
	4. 如果服务器没有收到客户端的指令，则服务器会复制一些行为 ---- 服务器预测，比如复制玩家的按键（一直按W前进这种），但这是服务器的预测，服务器说了算
	4. 如果客户端没有收到服务器的指令，则最终收到时客户端会被服务器中断，拉回来
	5. 即使客户端收到了服务器指令，也不是直接把法老之鹰绘制在最新更新到的位置上，而是通过插值算法顺滑的更新到最新的位置 （adaptive interpolation delay）
	6. adaptive interpolation delay：
		1. 该算法是为大多数情况下，可靠的网络环境（连接稳定、更新频率正常）设计的
		2. 意味着大多数情况下可以及时的收到服务器的指令
	7. 把跟你水平相当还有网络延迟相当的人配对在一起
3. responses 立即响应：
	1. 按键应该立即得到反馈（本地先行，不等待服务器确认）
	2. 但如果服务器不同意你的客户端行为（死亡，被眩晕），则会被插值算法迅速拉回
	3. 除了少数释放时间特别长的技能外，其它技能会立即执行模拟预测：
		1. 火箭会立即飞出，但不会立即命中
		2. 延迟的爆炸与伤害
		3. 要避免“秒杀”这种设计

----------
#### 王者荣耀（帧同步）

1. RTS --> 减少英雄数 --> 5到3个，变得更像MOBA
2. Demo （含引擎、框架、后台）2周就做完了，6个月做完第一个版本，2015-08-18上线
3. 不同步率，由最初的1%到现在的万分之几（资源加载失败导致的状态不一致）
4. client与server同步帧率为15fps，自己逻辑帧率为30fps
5. 性能优化：
	1. 战斗时不使用反射，加载时可以
	2. 把对象的显示隐藏放到不同的渲染层里面去
	3. 王者的gc平均每帧在1K左右，很难做到200
	2. 3DUI，
	2. Loading时加载了所有东西，所以加载时间长
6. 单CPU满（发热、降频），其中逻辑消耗占20%左右，但GPU只吃到了30%
7. 服务器的主频其实不高
8. 无缓冲无预测的帧同步

----------
#### 其它问题
1. behaviac插件对AI设计的影响
2. 寻路，服务器bake vs. 路点，服务器开销，随机地图
3. 中途加入

----------
#### Reference
1. [《王者荣耀》技术总监复盘回炉历程：没跨过这三座大山，就是另一款MOBA霸占市场了](http://youxiputao.com/articles/11842)
1. [【王者荣耀】透视+无CD+无敌外挂分析](http://gslab.qq.com/article-260-1.html)
1. [从《王者荣耀》谈游戏的帧同步](https://mp.weixin.qq.com/s?__biz=MzA4MDc5OTg5MA==&mid=2650595000&idx=1&sn=a5dcf715bbb05974b83c0a46c83931cd&chksm=8796cf45b0e1465308c925b6e6bc20ae9eea51b055b83eeea1b5eaf768eba3745f5cfe7695a0&mpshare=1&scene=1&srcid=0908p4HoMZy1FKv3j6UNCygl&key=5eaf808b4d91a6b91a3526583019f48440fc6fd6d4cd9586ca1d7c8fbc3d66381b924264b1d1f893888d63a393caefa707a4f26f3d31c4fe05526c86c830781c7158cdca06387b9729ddb95650078273&ascene=0&uin=MTU0NDI4MDE4MA%3D%3D&devicetype=iMac17%2C1+OSX+OSX+10.12.5+build(16F73)&version=12020110&nettype=WIFI&fontScale=100&pass_ticket=eSPQJVhDFk9932pH3RfLobgYK%2Fdd3aloMBXu9nU%2BlizPIDIbVSe54a0T78oAKTd6)
3. [游戏中的网络同步机制——Lockstep](http://bindog.github.io/blog/2015/03/10/synchronization-in-multiplayer-networked-game-lockstep/?utm_source=tuicool&utm_medium=referral)
4. [《守望先锋》技术分享视频：如何处理网络同步与减少网络迟疑（状态同步）](http://mp.weixin.qq.com/s?__biz=MjM5NTMxNTU0MQ==&mid=2649869814&idx=1&sn=c8da90fbfe553d9a434288d81f972a87&scene=2&srcid=07056E5ckMN3MZDBmRy33qoA&from=timeline&isappinstalled=0#wechat_redirect)
5. [网络游戏的移动同步（五）帧同步算法](http://www.zhust.com/index.php/2015/08/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A7%BB%E5%8A%A8%E5%90%8C%E6%AD%A5%EF%BC%88%E4%BA%94%EF%BC%89%E5%B8%A7%E5%90%8C%E6%AD%A5%E7%AE%97%E6%B3%95/)
6. [帧锁定同步算法](http://www.skywind.me/blog/archives/131)
7. [网络游戏同步法则](http://www.skywind.me/blog/archives/112)
8. [影子跟随算法（2007年老文一篇）](http://www.skywind.me/blog/archives/1145)

